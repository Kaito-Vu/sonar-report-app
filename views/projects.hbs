{{!< layout}}

<div class="flex justify-between items-center mb-6">
  <h2 class="text-2xl font-bold text-gray-800 dark:text-slate-200 flex items-center gap-2">
    <span class="iconify text-blue-600 dark:text-blue-400" data-icon="mdi:view-dashboard"></span>
    Danh sách Dự án
  </h2>
  <div class="flex gap-2">
    <button class="bg-blue-600 dark:bg-blue-700 text-white hover:bg-blue-700 dark:hover:bg-blue-600 px-4 py-2 rounded-lg font-bold shadow-sm transition" onclick="document.getElementById('addProjectForm').scrollIntoView({behavior: 'smooth'})">
      + Thêm Dự Án
    </button>
    <a href="/settings" class="bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-slate-300 px-4 py-2 rounded-lg font-medium border border-gray-200 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700 transition">
      <span class="iconify" data-icon="mdi:cog"></span> Cấu hình
    </a>
  </div>
</div>

<div class="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 overflow-hidden mb-8">
  <table class="w-full text-left text-sm text-gray-600 dark:text-slate-300">
    <thead class="bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-slate-300 uppercase text-xs font-bold">
    <tr>
      <th class="px-6 py-4">Tên Dự Án</th>
      <th class="px-6 py-4">Sonar Project Key (Technical ID)</th>
      <th class="px-6 py-4">Lần Scan Cuối</th>
      <th class="px-6 py-4 text-center">Trạng thái</th>
      <th class="px-6 py-4 text-right">Thao tác</th>
    </tr>
    </thead>
    <tbody class="divide-y divide-gray-100 dark:divide-slate-700">
    {{#each projects}}
      <tr class="hover:bg-gray-50 dark:hover:bg-slate-700 transition group">
        <td class="px-6 py-4">
          <a href="/project/{{this.id}}" class="font-bold text-gray-900 dark:text-slate-100 hover:text-blue-600 dark:hover:text-blue-400 text-base flex items-center gap-2">
            <span class="iconify text-gray-400 dark:text-slate-500 group-hover:text-blue-500 dark:group-hover:text-blue-400" data-icon="mdi:folder-outline"></span>
            {{this.name}}
          </a>
        </td>

        <td class="px-6 py-4">
                    <span class="font-mono text-xs text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded border border-blue-100 dark:border-blue-800 select-all block max-w-[300px] truncate" title="{{this.key}}">
                      {{this.key}}
                    </span>
        </td>

        <td class="px-6 py-4 text-xs">
          {{#if this.lastScan}}
            <div class="flex items-center gap-1 text-gray-700 dark:text-slate-300">
              <span class="iconify" data-icon="mdi:clock-outline"></span> {{this.lastScan}}
            </div>
          {{else}}
            <span class="text-gray-400 dark:text-slate-500 italic">Chưa có dữ liệu</span>
          {{/if}}
        </td>

        <td class="px-6 py-4 text-center">
          {{#if this.lastStatus}}
            {{#if (eq this.lastStatus 'COMPLETED')}}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">Hoàn thành</span>
            {{else}}{{#if (eq this.lastStatus 'FAILED')}}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">Lỗi</span>
            {{else}}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                                {{this.lastStatus}} <span class="iconify animate-spin ml-1" data-icon="mdi:loading"></span>
                            </span>
            {{/if}}{{/if}}
          {{else}}
            -
          {{/if}}
        </td>

        <td class="px-6 py-4 text-right">
          <div class="flex items-center justify-end gap-2">
            <button onclick="syncProject({{this.id}}, '{{this.name}}')" class="bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 dark:hover:bg-blue-600 text-white px-3 py-1.5 rounded transition flex items-center gap-1 text-xs font-bold shadow-sm">
              <span class="iconify" data-icon="mdi:cloud-sync"></span> Sync
            </button>
            <button onclick="deleteProject({{this.id}}, '{{this.name}}')" class="text-gray-400 dark:text-slate-500 hover:text-red-600 dark:hover:text-red-400 p-2 rounded hover:bg-red-50 dark:hover:bg-red-900/30 transition" title="Xóa dự án">
              <span class="iconify w-5 h-5" data-icon="mdi:trash-can-outline"></span>
            </button>
          </div>
        </td>
      </tr>
    {{/each}}
    </tbody>
  </table>
  {{#unless projects}}
    <div class="text-center py-16">
      <span class="iconify w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-slate-600" data-icon="mdi:folder-open-outline"></span>
      <p class="text-gray-500 dark:text-slate-400 mb-4">Chưa có dự án nào.</p>
    </div>
  {{/unless}}
</div>

<div id="addProjectForm" class="bg-gray-50 dark:bg-slate-800 p-6 rounded-xl border border-gray-200 dark:border-slate-700 max-w-2xl mx-auto">
  <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-slate-200 flex items-center gap-2">
    <span class="iconify text-blue-600" data-icon="mdi:plus-circle"></span> Thêm Dự Án Mới
  </h3>
  <form action="/projects" method="post" class="space-y-4">
    <div>
      <label class="block text-sm font-bold text-gray-700 dark:text-slate-300 mb-1">Tên hiển thị (Project Name)</label>
      <input type="text" name="name" class="w-full border border-gray-300 dark:border-slate-600 rounded-lg px-3 py-2 bg-white dark:bg-slate-700 text-gray-900 dark:text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="VD: Hệ thống Quản lý" required>
    </div>
    <div>
      <label class="block text-sm font-bold text-gray-700 dark:text-slate-300 mb-1">SonarQube Project Key <span class="text-red-500">*</span></label>
      <input type="text" name="key" class="w-full border border-gray-300 dark:border-slate-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm bg-white dark:bg-slate-700 text-gray-900 dark:text-slate-200" placeholder="VD: etc_bca_c10_c10-pms_..." required>
      <p class="text-xs text-blue-600 dark:text-blue-400 mt-1">
        <span class="iconify inline" data-icon="mdi:information-outline"></span>
        Lấy chính xác giá trị <b>Project Key</b> trong file PDF báo cáo hoặc trên giao diện SonarQube (thường là chuỗi dài).
      </p>
    </div>
    <div class="flex justify-end pt-2">
      <button type="submit" class="bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 dark:hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg transition flex items-center gap-2">
        <span class="iconify" data-icon="mdi:check"></span> Tạo Dự Án
      </button>
    </div>
  </form>
</div>

<script>
  function deleteProject(id, name) {
    showConfirm('Xóa dự án', `Bạn có chắc muốn xóa dự án "${name}"? Hành động này không thể hoàn tác.`, () => {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/projects/delete';
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'id';
      input.value = id;
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    });
  }
  
  async function syncProject(id, name) {
    showConfirm('Đồng bộ báo cáo', `Bắt đầu đồng bộ báo cáo cho dự án "${name}"?`, async () => {

      document.body.style.cursor = 'wait';
      try {
        const res = await fetch(`/projects/${id}/sync`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
          if (data.skipped) {
            showToast('Thông báo: ' + data.message, 'info');
          } else {
            showToast('✅ Đã gửi lệnh Sync thành công! Chuyển hướng đến lịch sử...', 'success');
            setTimeout(() => window.location.href = `/project/${id}`, 1000);
          }
        } else {
          showToast('❌ Lỗi: ' + data.message, 'error');
        }
      } catch (e) {
        showToast('Lỗi kết nối server.', 'error');
      } finally {
        document.body.style.cursor = 'default';
      }
    }, 'Đồng bộ', 'bg-indigo-600 hover:bg-indigo-700');
  }
</script>