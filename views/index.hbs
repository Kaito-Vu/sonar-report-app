{{!< layout}}

<div class="flex justify-between items-center mb-6">
  <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
    <span class="iconify text-blue-600" data-icon="mdi:view-dashboard"></span>
    Danh sách Dự án
  </h2>
  <div class="flex gap-2">
    <a href="/projects" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg flex items-center gap-2 transition text-sm font-medium border border-gray-200">
      <span class="iconify" data-icon="mdi:plus-circle"></span> Thêm Dự án
    </a>
    <a href="/settings" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg flex items-center gap-2 transition text-sm font-medium border border-gray-200">
      <span class="iconify" data-icon="mdi:cog"></span> Cấu hình
    </a>
  </div>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
  <table class="w-full text-left text-sm text-gray-600">
    <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
    <tr>
      <th class="px-6 py-4">Tên Dự án</th>
      <th class="px-6 py-4">Sonar Key</th>
      <th class="px-6 py-4">Scan Gần Nhất</th>
      <th class="px-6 py-4 text-center">Trạng thái</th>
      <th class="px-6 py-4 text-right">Thao tác</th>
    </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
    {{#each projects}}
      <tr class="hover:bg-gray-50 transition group">
        <td class="px-6 py-4">
          <a href="/project/{{this.id}}" class="font-bold text-gray-900 hover:text-blue-600 text-base flex items-center gap-2">
            <span class="iconify text-gray-400 group-hover:text-blue-500" data-icon="mdi:folder-outline"></span>
            {{this.name}}
          </a>
        </td>

        <td class="px-6 py-4">
                    <span class="font-mono text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-100 select-all">
                      {{this.key}}
                    </span>
        </td>

        <td class="px-6 py-4 text-xs">
          {{#if this.lastScan}}
            <div class="flex items-center gap-1 text-gray-700">
              <span class="iconify" data-icon="mdi:clock-outline"></span> {{this.lastScan}}
            </div>
          {{else}}
            <span class="text-gray-400 italic">Chưa có dữ liệu</span>
          {{/if}}
        </td>

        <td class="px-6 py-4 text-center">
          {{#if this.lastStatus}}
            {{#if (eq this.lastStatus 'COMPLETED')}}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">Hoàn thành</span>
            {{else}}{{#if (eq this.lastStatus 'FAILED')}}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">Lỗi</span>
            {{else}}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                                {{this.lastStatus}} <span class="iconify animate-spin ml-1" data-icon="mdi:loading"></span>
                            </span>
            {{/if}}{{/if}}
          {{else}}
            -
          {{/if}}
        </td>

        <td class="px-6 py-4 text-right">
          <div class="flex items-center justify-end gap-2">
            <button onclick="syncProject({{this.id}}, '{{this.name}}')"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded transition flex items-center gap-1 text-xs font-bold shadow-sm">
              <span class="iconify" data-icon="mdi:cloud-sync"></span> Sync
            </button>
            <a href="/project/{{this.id}}"
               class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 px-3 py-1.5 rounded transition flex items-center gap-1 text-xs font-bold shadow-sm">
              <span class="iconify" data-icon="mdi:file-document-multiple-outline"></span> Chi tiết
            </a>
          </div>
        </td>
      </tr>
    {{/each}}
    </tbody>
  </table>
  {{#unless projects}}
    <div class="text-center py-16">
      <span class="iconify w-16 h-16 mx-auto mb-4 text-gray-300" data-icon="mdi:folder-open-outline"></span>
      <p class="text-gray-500 mb-4">Chưa có dự án nào trong hệ thống.</p>
      <a href="/projects" class="text-blue-600 font-bold hover:underline">Tạo dự án mới ngay</a>
    </div>
  {{/unless}}
</div>

<script>
  async function syncProject(id, name) {
    if(!confirm(`Bắt đầu đồng bộ báo cáo cho dự án "${name}"?`)) return;
    document.body.style.cursor = 'wait';
    try {
      const res = await fetch(`/projects/${id}/sync`, { method: 'POST' });
      const data = await res.json();
      if (data.success) {
        alert('✅ Đã gửi lệnh Sync! Đang chuyển đến trang lịch sử...');
        window.location.href = `/project/${id}`;
      } else {
        alert('❌ Lỗi: ' + data.message);
      }
    } catch (e) { alert('Lỗi mạng.'); }
    finally { document.body.style.cursor = 'default'; }
  }
</script>