{{!< layout}}

<div class="h-full flex flex-col p-4 space-y-4 dark:text-slate-200">

  <div class="flex-none flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <div class="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 mb-1">
        <a href="/" class="hover:text-indigo-600 dark:hover:text-indigo-400 transition">Trang chủ</a>
        <span class="iconify text-xs" data-icon="mdi:chevron-right"></span>
        <a href="/project/{{report.project.id}}" class="hover:text-indigo-600 dark:hover:text-indigo-400 transition">Lịch sử</a>
        <span class="iconify text-xs" data-icon="mdi:chevron-right"></span>
        <span class="text-slate-800 dark:text-slate-200 font-medium">Chi tiết</span>
      </div>
      <div class="flex items-center gap-3">
        <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200 tracking-tight">{{report.filename}}</h2>
        <span class="px-2 py-0.5 rounded text-xs font-semibold bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-600 font-mono">
          {{report.project.key}}
        </span>
      </div>
      <input type="hidden" id="autoProjectKey" value="{{report.project.key}}">
      <input type="hidden" id="currentSortBy" value="{{sort.by}}">
      <input type="hidden" id="currentSortOrder" value="{{sort.order}}">
    </div>

    <div class="flex items-center gap-2">
      <div class="text-xs text-slate-400 dark:text-slate-500 font-medium uppercase tracking-wider mr-2 hidden md:block">Xuất file</div>
      <button onclick="exportReport('html')" class="flex items-center gap-2 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 hover:border-indigo-500 dark:hover:border-indigo-500 hover:text-indigo-600 dark:hover:text-indigo-400 px-3 py-1.5 rounded-lg text-sm font-medium transition shadow-sm">
        <span class="iconify text-lg" data-icon="mdi:language-html5"></span> HTML
      </button>
      <button onclick="exportReport('pdf')" class="flex items-center gap-2 bg-rose-600 hover:bg-rose-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition shadow-sm">
        <span class="iconify text-lg" data-icon="mdi:file-pdf-box"></span> PDF
      </button>
    </div>
  </div>

  <div class="flex-none bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-sm overflow-hidden transition-all" id="dashboardContainer">

    <div class="bg-slate-50 dark:bg-slate-700 px-4 py-2 flex justify-between items-center cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-600 transition border-b border-slate-200 dark:border-slate-600 select-none" onclick="toggleDashboard()">
      <h3 class="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2 text-sm uppercase tracking-wide">
        <span class="iconify" data-icon="mdi:chart-box-outline"></span> Tổng quan thống kê
      </h3>
      <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
        <span id="dashStateText">Thu gọn</span>
        <span id="dashIcon" class="iconify transition-transform duration-300 rotate-180" data-icon="mdi:chevron-down"></span>
      </div>
    </div>

    <div id="dashboardContent" class="p-4 grid grid-cols-1 md:grid-cols-2 gap-6 bg-white dark:bg-slate-800">
      
      {{#if comparison}}
      <!-- Comparison Card -->
      <div class="md:col-span-2 border border-indigo-200 dark:border-indigo-800 rounded-lg overflow-hidden bg-indigo-50/50 dark:bg-indigo-900/20">
        <div class="p-4 border-b border-indigo-200 dark:border-indigo-800 bg-indigo-100 dark:bg-indigo-900/30">
          <h4 class="font-bold text-sm text-indigo-900 dark:text-indigo-200 flex items-center gap-2">
            <span class="iconify" data-icon="mdi:chart-line"></span>
            So sánh với báo cáo trước
            <a href="/report/{{comparison.previousReportId}}" class="text-xs text-indigo-600 dark:text-indigo-400 hover:underline ml-auto">
              Xem báo cáo trước
            </a>
          </h4>
        </div>
        <div class="p-4 grid grid-cols-1 md:grid-cols-4 gap-4">
          <div class="text-center">
            <p class="text-xs text-slate-600 dark:text-slate-400 mb-1">Tổng Issues</p>
            <p class="text-2xl font-bold {{#if (gt comparison.diff 0)}}text-rose-600 dark:text-rose-400{{else}}{{#if (lt comparison.diff 0)}}text-green-600 dark:text-green-400{{else}}text-slate-600 dark:text-slate-400{{/if}}{{/if}}">
              {{comparison.currentTotal}}
              {{#if comparison.diff}}
                <span class="text-sm ml-1">
                  ({{#if (gt comparison.diff 0)}}+{{/if}}{{comparison.diff}})
                </span>
              {{/if}}
            </p>
            <p class="text-xs text-slate-500 dark:text-slate-500 mt-1">
              Trước: {{comparison.previousTotal}}
            </p>
          </div>
          <div class="text-center">
            <p class="text-xs text-slate-600 dark:text-slate-400 mb-1">Issues Mới</p>
            <p class="text-2xl font-bold {{#if (gt comparison.newIssuesCount 0)}}text-amber-600 dark:text-amber-400{{else}}text-green-600 dark:text-green-400{{/if}}">
              {{comparison.newIssuesCount}}
              <span class="iconify inline text-lg" data-icon="mdi:new-box"></span>
            </p>
            <p class="text-xs text-slate-500 dark:text-slate-500 mt-1">
              Phát sinh mới
            </p>
          </div>
          <div class="text-center">
            <p class="text-xs text-slate-600 dark:text-slate-400 mb-1">Thay đổi</p>
            <p class="text-2xl font-bold {{#if (gt comparison.diff 0)}}text-rose-600 dark:text-rose-400{{else}}{{#if (lt comparison.diff 0)}}text-green-600 dark:text-green-400{{else}}text-slate-600 dark:text-slate-400{{/if}}{{/if}}">
              {{#if (gt comparison.diff 0)}}
                <span class="iconify inline" data-icon="mdi:arrow-up"></span>
              {{else}}
                {{#if (lt comparison.diff 0)}}
                  <span class="iconify inline" data-icon="mdi:arrow-down"></span>
                {{else}}
                  <span class="iconify inline" data-icon="mdi:minus"></span>
                {{/if}}
              {{/if}}
              {{comparison.diffPercent}}%
            </p>
          </div>
          <div class="text-center">
            <p class="text-xs text-slate-600 dark:text-slate-400 mb-1">Báo cáo trước</p>
            <p class="text-sm text-slate-700 dark:text-slate-300">
              {{comparison.previousDate}}
            </p>
          </div>
        </div>
      </div>
      {{/if}}

      {{#if comparison}}
      {{#if (gt comparison.newIssuesCount 0)}}
      <!-- New Issues Summary Card -->
      <div class="md:col-span-2 border border-amber-200 dark:border-amber-800 rounded-lg overflow-hidden bg-amber-50/50 dark:bg-amber-900/20">
        <div class="p-3 border-b border-amber-200 dark:border-amber-800 bg-amber-100 dark:bg-amber-900/30 flex justify-between items-center">
          <h4 class="font-bold text-sm text-amber-900 dark:text-amber-200 flex items-center gap-2">
            <span class="iconify" data-icon="mdi:new-box"></span>
            Issues Mới Phát Sinh ({{comparison.newIssuesCount}})
          </h4>
          <button onclick="document.getElementById('filterNewIssues').value='new'; applyFilters(); document.getElementById('dashboardContainer').scrollIntoView({ behavior: 'smooth', block: 'end' });" class="text-xs text-amber-700 dark:text-amber-300 hover:text-amber-900 dark:hover:text-amber-100 font-medium flex items-center gap-1 px-2 py-1 bg-white dark:bg-amber-900/40 rounded border border-amber-300 dark:border-amber-700 hover:bg-amber-50 dark:hover:bg-amber-900/60 transition">
            <span class="iconify" data-icon="mdi:filter"></span> Xem tất cả
          </button>
        </div>
        <div class="p-3">
          <p class="text-xs text-amber-800 dark:text-amber-300 mb-2">
            <span class="iconify inline" data-icon="mdi:information-outline"></span>
            Có <strong>{{comparison.newIssuesCount}} issues mới</strong> được phát hiện so với báo cáo trước.
            Sử dụng bộ lọc "Chỉ issues mới" để xem chi tiết hoặc cuộn xuống danh sách bên dưới.
          </p>
        </div>
      </div>
      {{/if}}
      {{/if}}

      <div class="border border-slate-100 dark:border-slate-700 rounded-lg overflow-hidden">
        <table class="w-full text-sm text-left">
          <thead class="bg-slate-50 text-xs text-slate-500 font-semibold uppercase">
          <tr>
            <th class="px-4 py-2">Loại vấn đề</th>
            <th class="px-4 py-2 text-right">Số lượng</th>
          </tr>
          </thead>
          <tbody class="divide-y divide-slate-50 dark:divide-slate-700">
          {{#each stats.byType}}
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
              <td class="px-4 py-2 font-medium flex items-center gap-2" style="color: {{this.color}}">
                <span class="iconify w-4 h-4" data-icon="mdi:circle-slice-8"></span> {{this.label}}
              </td>
              <td class="px-4 py-2 text-right font-bold text-slate-800">{{this.count}}</td>
            </tr>
          {{/each}}
          </tbody>
        </table>
      </div>

      <div class="border border-slate-100 rounded-lg overflow-hidden">
        <table class="w-full text-sm text-left">
          <thead class="bg-slate-50 text-xs text-slate-500 font-semibold uppercase">
          <tr>
            <th class="px-4 py-2">Mức độ nghiêm trọng</th>
            <th class="px-4 py-2 text-right">Số lượng</th>
          </tr>
          </thead>
          <tbody class="divide-y divide-slate-50 dark:divide-slate-700">
          {{#each stats.bySeverity}}
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition">
              <td class="px-4 py-2 font-medium flex items-center gap-2" style="color: {{this.color}}">
                <span class="iconify w-4 h-4" data-icon="mdi:alert-circle-outline"></span> {{this.label}}
              </td>
              <td class="px-4 py-2 text-right">
                <div class="flex items-center justify-end gap-2">
                  <span class="font-bold text-slate-800 dark:text-slate-200">{{this.count}}</span>
                  {{#if ../comparison}}
                    {{#with (lookup ../comparison.bySeverity @index)}}
                      {{#if this.diff}}
                        <span class="text-xs {{#if (gt this.diff 0)}}text-rose-600 dark:text-rose-400{{else}}text-green-600 dark:text-green-400{{/if}}">
                          ({{#if (gt this.diff 0)}}+{{/if}}{{this.diff}})
                        </span>
                      {{/if}}
                    {{/with}}
                  {{/if}}
                </div>
              </td>
            </tr>
          {{/each}}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="flex-1 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col min-h-0 overflow-hidden">

    <!-- Filter Bar -->
    <div class="px-4 py-3 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-700/50 flex flex-wrap gap-3 items-center">
      <div class="flex-1 min-w-[200px]">
        <input 
          type="search" 
          id="issueSearchInput" 
          placeholder="Tìm kiếm issues..." 
          class="w-full pl-10 pr-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none text-sm"
        >
        <span class="absolute left-6 top-1/2 transform -translate-y-1/2 iconify w-4 h-4 text-slate-400 dark:text-slate-500 pointer-events-none" data-icon="mdi:magnify"></span>
      </div>
      <select id="filterType" class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-200 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
        <option value="">Tất cả Type</option>
        <option value="BUG">BUG</option>
        <option value="VULNERABILITY">VULNERABILITY</option>
        <option value="SECURITY_HOTSPOT">SECURITY_HOTSPOT</option>
        <option value="CODE_SMELL">CODE_SMELL</option>
      </select>
      <select id="filterSeverity" class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-200 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
        <option value="">Tất cả Severity</option>
        <option value="BLOCKER">BLOCKER</option>
        <option value="CRITICAL">CRITICAL</option>
        <option value="MAJOR">MAJOR</option>
        <option value="MINOR">MINOR</option>
        <option value="INFO">INFO</option>
      </select>
      {{#if comparison}}
      <select id="filterNewIssues" class="px-3 py-2 border border-amber-300 dark:border-amber-600 rounded-lg bg-amber-50 dark:bg-amber-900/20 text-slate-900 dark:text-slate-200 text-sm focus:ring-2 focus:ring-amber-500 outline-none font-medium">
        <option value="">Tất cả issues</option>
        <option value="new">Chỉ issues mới</option>
        <option value="existing">Chỉ issues cũ</option>
      </select>
      {{/if}}
      <button onclick="clearFilters()" class="px-3 py-2 text-sm text-slate-600 dark:text-slate-300 hover:text-slate-900 dark:hover:text-slate-100 border border-slate-300 dark:border-slate-600 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition">
        <span class="iconify w-4 h-4" data-icon="mdi:filter-off"></span> Xóa bộ lọc
      </button>
    </div>

    <div class="px-4 py-2 border-b border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-700/30 flex justify-between items-center text-xs text-slate-500 dark:text-slate-400">
      <span class="font-medium flex items-center gap-1">
        <span class="iconify" data-icon="mdi:format-list-bulleted"></span>
        Danh sách chi tiết lỗi (<span id="filteredCount">{{pagination.total}}</span>)
      </span>
      <span class="italic">Click tiêu đề cột để sắp xếp</span>
    </div>

    <div class="flex-1 overflow-y-auto custom-scrollbar">
      <table class="w-full text-left border-collapse table-fixed">
        <thead class="bg-slate-800 dark:bg-slate-900 text-slate-200 dark:text-slate-300 text-xs font-semibold uppercase tracking-wide sticky top-0 z-10 shadow-md">
        <tr>
          <th class="px-4 py-3 w-32 cursor-pointer hover:bg-slate-700 hover:text-white transition sort-header" data-sort="type">
            <div class="flex items-center gap-1">Type <span class="iconify text-slate-400 sort-icon" data-col="type" data-icon="mdi:unfold-more-horizontal"></span></div>
          </th>
          <th class="px-4 py-3 w-28 text-center cursor-pointer hover:bg-slate-700 hover:text-white transition sort-header" data-sort="severity">
            <div class="flex items-center justify-center gap-1">Severity <span class="iconify text-slate-400 sort-icon" data-col="severity" data-icon="mdi:unfold-more-horizontal"></span></div>
          </th>
          <th class="px-4 py-3 w-48 cursor-pointer hover:bg-slate-700 hover:text-white transition sort-header" data-sort="ruleKey">
            <div class="flex items-center gap-1">Rule Key <span class="iconify text-slate-400 sort-icon" data-col="ruleKey" data-icon="mdi:unfold-more-horizontal"></span></div>
          </th>
          <th class="px-4 py-3 w-1/4 cursor-pointer hover:bg-slate-700 hover:text-white transition sort-header" data-sort="fileName">
            <div class="flex items-center gap-1">File Path <span class="iconify text-slate-400 sort-icon" data-col="fileName" data-icon="mdi:unfold-more-horizontal"></span></div>
          </th>
          <th class="px-4 py-3 w-20 text-center cursor-pointer hover:bg-slate-700 hover:text-white transition sort-header" data-sort="fileLine">Line</th>
          <th class="px-4 py-3">Message</th>
          <th class="px-4 py-3 w-24 text-center bg-slate-900 border-l border-slate-700">Action</th>
        </tr>
        </thead>

        <tbody id="issuesTableBody" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm text-slate-600 dark:text-slate-300">
        {{#if issues.length}}
          {{#each issues}}
            <tr class="hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors duration-150 group issue-row {{#if this.isNew}}bg-amber-50/30 dark:bg-amber-900/10{{/if}}"
                data-type="{{this.type}}"
                data-severity="{{this.severity}}"
                data-message="{{this.message}}"
                data-file="{{this.fileName}}"
                data-rule="{{this.ruleKey}}"
                data-is-new="{{this.isNew}}">

              <td class="px-4 py-3 align-top">
                <div class="flex flex-col gap-1.5">
                  <div>
                    {{#if (eq this.type 'BUG')}}
                      <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-rose-50 text-rose-700 border border-rose-100"><span class="iconify" data-icon="mdi:bug"></span> BUG</span>
                    {{else}}{{#if (eq this.type 'VULNERABILITY')}}
                      <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-amber-50 text-amber-700 border border-amber-100"><span class="iconify" data-icon="mdi:lock-open-alert"></span> VULN</span>
                    {{else}}{{#if (eq this.type 'SECURITY_HOTSPOT')}}
                      <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-indigo-50 text-indigo-700 border border-indigo-100"><span class="iconify" data-icon="mdi:eye-circle"></span> HOTSPOT</span>
                    {{else}}
                      <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold bg-blue-50 text-blue-700 border border-blue-100"><span class="iconify" data-icon="mdi:code-braces"></span> SMELL</span>
                    {{/if}}{{/if}}{{/if}}
                  </div>
                  {{#if this.isNew}}
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[9px] font-bold bg-gradient-to-r from-amber-400 to-orange-500 text-white shadow-sm animate-pulse w-fit">
                      <span class="iconify" data-icon="mdi:new-box"></span> MỚI
                    </span>
                  {{/if}}
                </div>
              </td>

              <td class="px-4 py-3 text-center align-top">
                                <span class="inline-block px-2 py-1 rounded text-[10px] font-bold border shadow-sm
                                    {{#if (eq this.severity 'BLOCKER')}}bg-rose-100 text-rose-800 border-rose-200
                                    {{else}}{{#if (eq this.severity 'CRITICAL')}}bg-orange-100 text-orange-800 border-orange-200
                                    {{else}}{{#if (eq this.severity 'MAJOR')}}bg-pink-50 text-pink-800 border-pink-100
                                    {{else}}bg-slate-100 text-slate-600 border-slate-200{{/if}}{{/if}}{{/if}}">
                                  {{this.severity}}
                                </span>
              </td>

              <td class="px-4 py-3 align-top">
                                <span class="font-mono text-[10px] text-slate-500 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 break-all block">
                                  {{this.ruleKey}}
                                </span>
              </td>

              <td class="px-4 py-3 align-top">
                <div class="text-xs text-slate-500 break-all font-mono leading-relaxed hover:text-indigo-600 cursor-help transition" title="{{this.fileName}}">
                  {{this.fileName}}
                </div>
              </td>

              <td class="px-4 py-3 text-center align-top font-bold text-slate-400 font-mono">
                {{#if (eq this.fileLine 0)}}-{{else}}{{this.fileLine}}{{/if}}
              </td>

              <td class="px-4 py-3 align-top">
                <div class="text-slate-900 font-medium break-words leading-snug min-w-[200px]">{{this.message}}</div>
              </td>

              <td class="px-4 py-3 text-center align-top border-l border-slate-100 bg-slate-50/50">
                <button class="btn-fix bg-white text-indigo-600 border border-indigo-200 px-3 py-1.5 rounded shadow-sm text-xs font-bold w-full hover:bg-indigo-600 hover:text-white transition flex items-center justify-center gap-1 group-hover:border-indigo-400"
                        data-rule="{{this.ruleKey}}"
                        data-file="{{this.fileName}}"
                        data-line="{{this.fileLine}}">
                  <span class="iconify" data-icon="mdi:wrench"></span> Fix
                </button>
              </td>
            </tr>
          {{/each}}
        {{else}}
          <tr>
            <td colspan="7" class="p-16 text-center text-slate-400">
              <div class="flex flex-col items-center justify-center">
                <span class="iconify w-12 h-12 mb-3 text-slate-200" data-icon="mdi:clipboard-check-outline"></span>
                <p>Không tìm thấy vấn đề nào.</p>
              </div>
            </td>
          </tr>
        {{/if}}
        </tbody>
      </table>
    </div>

    <div class="flex-none bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 px-4 py-3 flex flex-wrap gap-4 items-center justify-between text-sm text-slate-600 dark:text-slate-300 z-20">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2 bg-slate-50 dark:bg-slate-700 p-1 rounded-lg border border-slate-200 dark:border-slate-600">
          <span class="pl-2 text-xs font-medium text-slate-500 dark:text-slate-400">Hiển thị</span>
          <select id="pageSizeSelect" class="bg-transparent dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-xs font-bold outline-none cursor-pointer pr-1 py-1">
            {{#each pagination.pageSizeOptions}}
              <option value="{{this.value}}" {{#if this.selected}}selected{{/if}}>{{this.value}}</option>
            {{/each}}
          </select>
        </div>
        <div class="text-xs">
          Tổng cộng: <b class="text-indigo-600 text-sm">{{pagination.total}}</b> issues
        </div>
      </div>

      <div class="flex items-center gap-1">
        <button onclick="changePage({{pagination.prevPage}})" class="w-8 h-8 flex items-center justify-center rounded border border-slate-200 dark:border-slate-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 hover:text-indigo-600 dark:hover:text-indigo-400 disabled:opacity-50 transition" {{#unless pagination.hasPrev}}disabled{{/unless}}>
          <span class="iconify" data-icon="mdi:chevron-left"></span>
        </button>

        <div class="flex items-center gap-1 px-2">
          <span>Trang</span>
          <input type="number" id="pageInput" value="{{pagination.page}}" min="1" max="{{pagination.totalPages}}"
                 class="w-10 text-center text-xs border border-slate-200 dark:border-slate-600 rounded py-1 bg-white dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 font-bold outline-none focus:ring-1 focus:ring-indigo-500">
          <span>/ {{pagination.totalPages}}</span>
        </div>

        <button id="btnGoPage" class="px-2 text-[10px] font-bold uppercase text-slate-500 hover:text-indigo-600">Đi</button>

        <button onclick="changePage({{pagination.nextPage}})" class="w-8 h-8 flex items-center justify-center rounded border border-slate-200 dark:border-slate-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 hover:text-indigo-600 dark:hover:text-indigo-400 disabled:opacity-50 transition" {{#unless pagination.hasNext}}disabled{{/unless}}>
          <span class="iconify" data-icon="mdi:chevron-right"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<div id="customModal" class="hidden fixed inset-0 z-[9999] flex items-center justify-center" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div id="modalBackdrop" class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity cursor-pointer"></div>
  <div class="relative bg-white w-full max-w-5xl h-[85vh] rounded-xl shadow-2xl flex flex-col overflow-hidden transform transition-all border border-slate-200">
    <div class="flex justify-between items-center px-6 py-4 bg-slate-50 border-b border-slate-200">
      <div><h3 class="font-bold text-lg text-slate-800 flex items-center gap-2"><span class="iconify text-emerald-600 w-6 h-6" data-icon="mdi:shield-bug-outline"></span> Hướng dẫn khắc phục</h3></div>
      <button id="btnCloseModal" class="text-slate-400 hover:text-rose-600 hover:bg-rose-50 p-2 rounded-full transition focus:outline-none"><span class="iconify w-6 h-6" data-icon="mdi:close"></span></button>
    </div>
    <div class="flex border-b border-slate-200 bg-white">
      <button class="tab-btn flex-1 py-4 text-sm font-bold text-slate-500 hover:text-indigo-600 hover:bg-slate-50 transition border-b-2 border-transparent active-tab flex justify-center items-center gap-2" data-target="tab-rule"><span class="iconify w-5 h-5" data-icon="mdi:book-open-page-variant-outline"></span> Why & How</button>
      <button class="tab-btn flex-1 py-4 text-sm font-bold text-slate-500 hover:text-indigo-600 hover:bg-slate-50 transition border-b-2 border-transparent flex justify-center items-center gap-2" data-target="tab-code"><span class="iconify w-5 h-5" data-icon="mdi:code-tags"></span> Source Code</button>
    </div>
    <div class="flex-1 overflow-y-auto bg-slate-50 relative">
      <div id="tab-rule" class="tab-content block p-8 bg-white min-h-full"><div id="ruleContent" class="prose max-w-none text-sm text-slate-800 leading-relaxed">Loading...</div></div>
      <div id="tab-code" class="tab-content hidden p-6">
        <div id="manualKeySection" class="hidden mb-6 bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-center gap-4 shadow-sm">
          <div class="text-amber-600 bg-amber-100 p-2 rounded-full"><span class="iconify w-6 h-6" data-icon="mdi:alert-circle-outline"></span></div>
          <div class="flex-1"><h4 class="text-sm font-bold text-amber-900">Chưa liên kết Project Key</h4><p class="text-xs text-amber-700 mt-1">Nhập Key thủ công:</p></div>
          <div class="flex gap-2"><input type="text" id="manualProjectKey" class="border border-amber-300 rounded px-3 py-1.5 text-sm w-48 font-mono"><button id="btnManualFetch" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-1.5 rounded text-sm font-bold shadow-sm">Tải Code</button></div>
        </div>
        <div id="codeDisplay" class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden font-mono text-sm min-h-[200px]"></div>
      </div>
    </div>
  </div>
</div>
<style>.active-tab { border-bottom-color: #4f46e5 !important; color: #4f46e5 !important; background-color: #ffffff; }</style>

{{> script_detail }}

<script>
  // Function Toggle Dashboard
  function toggleDashboard() {
    const content = document.getElementById('dashboardContent');
    const icon = document.getElementById('dashIcon');
    const text = document.getElementById('dashStateText');

    if (content.style.display === 'none') {
      content.style.display = 'grid';
      icon.style.transform = 'rotate(180deg)';
      text.innerText = 'Thu gọn';
    } else {
      content.style.display = 'none';
      icon.style.transform = 'rotate(0deg)';
      text.innerText = 'Mở rộng';
    }
  }

  // Filter functionality
  function applyFilters() {
    const searchTerm = document.getElementById('issueSearchInput')?.value.toLowerCase() || '';
    const filterType = document.getElementById('filterType')?.value || '';
    const filterSeverity = document.getElementById('filterSeverity')?.value || '';
    const filterNewIssues = document.getElementById('filterNewIssues')?.value || '';
    const rows = document.querySelectorAll('.issue-row');
    let visibleCount = 0;

    rows.forEach(row => {
      const type = row.dataset.type || '';
      const severity = row.dataset.severity || '';
      const message = (row.dataset.message || '').toLowerCase();
      const file = (row.dataset.file || '').toLowerCase();
      const rule = (row.dataset.rule || '').toLowerCase();
      const isNew = row.dataset.isNew === 'true';

      const matchesSearch = !searchTerm ||
        message.includes(searchTerm) ||
        file.includes(searchTerm) ||
        rule.includes(searchTerm);
      const matchesType = !filterType || type === filterType;
      const matchesSeverity = !filterSeverity || severity === filterSeverity;
      const matchesNewFilter = !filterNewIssues ||
        (filterNewIssues === 'new' && isNew) ||
        (filterNewIssues === 'existing' && !isNew);

      const visible = matchesSearch && matchesType && matchesSeverity && matchesNewFilter;
      row.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    const countEl = document.getElementById('filteredCount');
    if (countEl) countEl.textContent = visibleCount;
  }

  function clearFilters() {
    const searchInput = document.getElementById('issueSearchInput');
    const filterType = document.getElementById('filterType');
    const filterSeverity = document.getElementById('filterSeverity');
    const filterNewIssues = document.getElementById('filterNewIssues');

    if (searchInput) searchInput.value = '';
    if (filterType) filterType.value = '';
    if (filterSeverity) filterSeverity.value = '';
    if (filterNewIssues) filterNewIssues.value = '';

    applyFilters();
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Filter event listeners
    const searchInput = document.getElementById('issueSearchInput');
    const filterType = document.getElementById('filterType');
    const filterSeverity = document.getElementById('filterSeverity');
    const filterNewIssues = document.getElementById('filterNewIssues');

    if (searchInput) {
      searchInput.addEventListener('input', window.searchFilter?.debounce(applyFilters, 300) || applyFilters);
    }
    if (filterType) filterType.addEventListener('change', applyFilters);
    if (filterSeverity) filterSeverity.addEventListener('change', applyFilters);
    if (filterNewIssues) filterNewIssues.addEventListener('change', applyFilters);
    const currentSortBy = document.getElementById('currentSortBy').value;
    const currentSortOrder = document.getElementById('currentSortOrder').value;

    window.reloadPage = (params) => {
      const url = new URL(window.location.href);
      for (const key in params) { url.searchParams.set(key, params[key]); }
      window.location.href = url.toString();
    };

    const sortIcon = document.querySelector(`.sort-icon[data-col="${currentSortBy}"]`);
    if (sortIcon) {
      sortIcon.classList.remove('text-slate-400'); sortIcon.classList.add('text-amber-400');
      sortIcon.setAttribute('data-icon', currentSortOrder === 'asc' ? 'mdi:arrow-up' : 'mdi:arrow-down');
      sortIcon.closest('th').classList.add('bg-slate-700');
    }

    document.querySelectorAll('.sort-header').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.dataset.sort;
        let newOrder = 'asc';
        if (column === currentSortBy) { newOrder = currentSortOrder === 'asc' ? 'desc' : 'asc'; }
        reloadPage({ sortBy: column, sortOrder: newOrder, page: 1 });
      });
    });

    window.changePage = (page) => reloadPage({ page: page });
    document.getElementById('pageSizeSelect').addEventListener('change', (e) => reloadPage({ pageSize: e.target.value, page: 1 }));

    // Export with progress
    window.exportReport = function(type) {
      const url = `/report/{{report.id}}/export?type=${type}`;
      showToast(`Đang xuất file ${type.toUpperCase()}...`, 'info');
      
      // Open in new tab
      const link = document.createElement('a');
      link.href = url;
      link.target = '_blank';
      link.click();
      
      setTimeout(() => {
        showToast(`Đã xuất file ${type.toUpperCase()} thành công!`, 'success');
      }, 1000);
    };

    const handleGo = () => {
      let p = parseInt(document.getElementById('pageInput').value);
      reloadPage({ page: p });
    };
    document.getElementById('btnGoPage').addEventListener('click', handleGo);
    document.getElementById('pageInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleGo(); });
  });
</script>